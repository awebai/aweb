{"id":"aweb-2n8","title":"Prepare aweb for PyPI publication","description":"Fix all issues needed before publishing aweb to PyPI: duplicate migrations in wheel, missing routes/__init__.py, missing project.urls/classifiers, add dep minimum versions, rework README for consumers.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-03T23:08:15.096555Z","created_by":"Juan Reyero","updated_at":"2026-02-04T11:28:34.517166Z","closed_at":"2026-02-04T11:28:34.517166Z","close_reason":"PyPI prep complete: sdist/wheel build clean, twine check passes, README accurate, CLAUDE.md excluded"}
{"id":"aweb-3ty","title":"Version bump to 0.1.2 and notify downstream","description":"Bump pyproject.toml version to 0.1.2. Run all quality gates: pytest, mypy, black, isort, ruff, build, twine check. Notify downstream consumers: alice-coordinator (beadhub events.py orphaned code is now dead), bob-coordinator (aweb 0.1.2 adds sender_waiting), ivy-implementer (aweb 0.1.2 available), henry-implementer (feature shipped, client-side parsing works).","status":"in_progress","priority":2,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:35:15.08339Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:46:41.963388Z","dependencies":[{"issue_id":"aweb-3ty","depends_on_id":"aweb-e2f","type":"blocks","created_at":"2026-02-07T23:35:30.183496Z","created_by":"Juan Reyero"}]}
{"id":"aweb-5y5","title":"Un-hardcode targets_connected in POST /v1/chat/sessions","description":"Modify create_or_send() in chat.py: Add redis=Depends(get_redis). After _ensure_session, call get_waiting_agents(redis, session_id, target_ids). Map connected agent_ids back to aliases. Replace targets_connected=[] with actual connected aliases. Tests: test_create_or_send_targets_connected — Agent 2 has active SSE, Agent 1 sends, response includes agent 2's alias in targets_connected. test_create_or_send_targets_connected_empty — No SSE streams, targets_connected is [].","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:35:09.016759Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:46:35.975426Z","closed_at":"2026-02-07T23:46:35.975426Z","close_reason":"All endpoints wired, Lua TOCTOU fix, 24 tests passing","dependencies":[{"issue_id":"aweb-5y5","depends_on_id":"aweb-axv","type":"blocks","created_at":"2026-02-07T23:35:26.668395Z","created_by":"Juan Reyero"}]}
{"id":"aweb-91t","title":"Restore heartbeat endpoint lost in beadhub refactoring","description":"POST /v1/workspaces/heartbeat was dropped when beadhub was refactored from beadhub-main. The presence.py module and its tests survived intact, and routes that call into presence (register, mcp, status, agent listing) still work. But the heartbeat endpoint itself (~249 lines in beadhub-main workspaces.py lines 518-766) is missing.\n\nThe heartbeat endpoint is what the bdh CLI calls to refresh workspace presence. Without it, presence data goes stale and is never refreshed.\n\nReference implementation: beadhub-main/src/beadhub/routes/workspaces.py (search for 'heartbeat').\nRefactored codebase missing it: beadhub/src/beadhub/routes/workspaces.py.\n\nSteps the endpoint performs:\n1. Extract project_id from auth\n2. Pre-check workspace immutability (project_id + alias match)\n3. Resolve/create repo record (normalize git origin)\n4. Upsert workspace record in SQL (immutability constraints, alias collision check via DB + Redis)\n5. Update presence in Redis (best-effort) — hash + secondary indexes\n6. Cloud-only: track usage (non-blocking)\n7. Return OK\n\nPhilosophy: presence is a cache of SQL. SQL authoritative, Redis ephemeral.\n\nNote: only restore the beadhub-specific heartbeat. We discussed with Juan whether presence should live in aweb — conclusion is that workspace-level presence is beadhub-specific (repos, branches, workspace paths). Generic agent-level presence for aweb is a separate future concern.","status":"closed","priority":1,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:27:12.392001Z","created_by":"Juan Reyero","updated_at":"2026-02-04T09:27:57.213214Z","closed_at":"2026-02-04T09:27:57.213214Z","close_reason":"Created in wrong beads database (aweb instead of beadhub). Grace will create the issue in beadhub's beads."}
{"id":"aweb-acs","title":"aweb: replace assert with explicit check in chat session creation","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-03T13:57:43.667323Z","created_by":"Juan Reyero","updated_at":"2026-02-03T14:08:13.753577Z","closed_at":"2026-02-03T14:08:13.753577Z","close_reason":"Replaced assert with explicit check + HTTPException(500) + logging in _ensure_session()"}
{"id":"aweb-axv","title":"Wire SSE lifecycle tracking into _sse_events","description":"Modify src/aweb/routes/chat.py: Add redis param to _sse_events() signature. ZADD at start (before first yield). Track last_refresh, re-ZADD every 30s in the polling loop. Wrap body in try/finally, ZREM in finally. Add redis=Depends(get_redis) to stream() endpoint, pass to _sse_events. Tests in test_aweb_chat.py: test_sse_registers_waiting_in_redis — start SSE stream with redis, verify ZSCORE exists mid-stream, verify removed after stream ends. Existing redis=None tests must still pass.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:34:58.29969Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:46:35.971236Z","closed_at":"2026-02-07T23:46:35.971236Z","close_reason":"All endpoints wired, Lua TOCTOU fix, 24 tests passing","dependencies":[{"issue_id":"aweb-axv","depends_on_id":"aweb-cva","type":"blocks","created_at":"2026-02-07T23:35:21.370316Z","created_by":"Juan Reyero"}]}
{"id":"aweb-col","title":"aweb: fail fast when proxy headers trusted but internal secret missing","status":"closed","priority":1,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-03T13:57:43.044041Z","created_by":"Juan Reyero","updated_at":"2026-02-03T14:05:48.098992Z","closed_at":"2026-02-03T14:05:48.098992Z","close_reason":"Removed SESSION_SECRET_KEY fallback from _get_aweb_internal_auth_secret(); added validate_auth_config() for startup checks; added logging on runtime failure; added 5 tests to lock behavior"}
{"id":"aweb-cva","title":"Create chat_waiting module with Redis helpers","description":"Create src/aweb/chat_waiting.py with: _chat_waiting_key(session_id) → f'chat:waiting:{session_id}', register_waiting(redis, session_id, agent_id, ttl_seconds=90) — ZADD with time.time() score + EXPIRE, unregister_waiting(redis, session_id, agent_id) — ZREM, is_agent_waiting(redis, session_id, agent_id, max_age_seconds=90) — ZSCORE + stale check + auto-cleanup, get_waiting_agents(redis, session_id, agent_ids, max_age_seconds=90) — pipeline ZSCORE batch returning list of waiting ids. All functions no-op / return defaults when redis is None. Follow presence.py module pattern. Create tests/test_aweb_chat_waiting.py with: test_register_and_check_waiting, test_unregister_waiting, test_stale_entry_detected, test_get_waiting_agents_batch, test_none_redis_graceful.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:34:53.272358Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:37:07.519421Z","closed_at":"2026-02-07T23:37:07.519421Z","close_reason":"chat_waiting.py module + 5 passing tests"}
{"id":"aweb-e2f","title":"Add sender_waiting to GET /v1/chat/sessions","description":"Modify list_sessions() in chat.py: Add sender_waiting: bool = False to SessionListItem model. Add redis=Depends(get_redis) to endpoint. Add agent_id aggregation to SQL query. For each session, check if any non-self participant is waiting via get_waiting_agents. Tests: test_list_sessions_sender_waiting — Agent 1 has active SSE, Agent 2's session list shows sender_waiting: True.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:35:11.195776Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:46:35.976909Z","closed_at":"2026-02-07T23:46:35.976909Z","close_reason":"All endpoints wired, Lua TOCTOU fix, 24 tests passing","dependencies":[{"issue_id":"aweb-e2f","depends_on_id":"aweb-axv","type":"blocks","created_at":"2026-02-07T23:35:28.423645Z","created_by":"Juan Reyero"}]}
{"id":"aweb-gkv","title":"Epic: Agent-level presence and heartbeat for aweb","description":"aweb needs agent-level presence so that:\n- aw list-agents returns accurate online status (currently always offline)\n- Chat/mail senders can check recipient availability\n- beadhub's workspace heartbeat can sync to aweb's agent presence\n\nArchitecture: Redis-backed presence with TTL at the agent_id level. Simpler than beadhub's workspace presence (no repos, branches, workspace paths). beadhub's workspace heartbeat should also update aweb's agent presence as a side-effect.\n\nIncludes aweb server changes and aw Go client changes. beadhub integration tracked separately in beadhub's beads.","status":"closed","priority":1,"issue_type":"epic","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:30:28.174748Z","created_by":"Juan Reyero","updated_at":"2026-02-04T10:08:58.156312Z","closed_at":"2026-02-04T10:08:58.156312Z","close_reason":"All 6 sub-tasks complete: presence module, endpoints, client, CLI, and tests"}
{"id":"aweb-gkv.1","title":"Add GET /v1/agents endpoint","description":"aweb has no agent listing endpoint. The aw Go client (agents.go) calls GET /v1/agents and expects a ListAgentsResponse with project_id and a list of AgentView (agent_id, alias, human_name, agent_type, status, last_seen, online).\n\nThe endpoint should:\n- Require auth (Bearer API key)\n- Scope to the authenticated project_id\n- Query the agents table for all non-deleted agents in the project\n- Return the list matching the AgentView shape from aw/agents.go\n\nThis is needed independently of presence — even without online status, users need to list agents in their project.\n\nNote: the online/last_seen fields will be empty until presence is implemented (aweb-gkv children).","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:39:11.800491Z","created_by":"Juan Reyero","updated_at":"2026-02-04T09:56:08.368435Z","closed_at":"2026-02-04T09:56:08.368435Z","close_reason":"Implemented and tested: GET /v1/agents + presence module. 13 new tests passing.","dependencies":[{"issue_id":"aweb-gkv.1","depends_on_id":"aweb-gkv","type":"parent-child","created_at":"2026-02-04T09:39:11.801324Z","created_by":"Juan Reyero"}]}
{"id":"aweb-gkv.2","title":"Add agent presence module (Redis)","description":"Create src/aweb/presence.py — a Redis-backed agent presence module. Simpler than beadhub's workspace presence (no repos, branches, workspace paths).\n\nRedis data structures:\n- presence:agent:{agent_id} → Hash {agent_id, alias, project_id, status, last_seen} with TTL (default 30 min)\n- idx:project_agents:{project_id} → Set of agent_ids with active presence (2x TTL for lazy cleanup)\n\nFunctions needed:\n- update_agent_presence(redis, agent_id, alias, project_id, status='active', ttl_seconds=1800) → timestamp\n- get_agent_presence(redis, agent_id) → Optional dict\n- list_agent_presences_by_project(redis, project_id) → List of dicts\n- list_agent_presences_by_ids(redis, agent_ids) → List of dicts (for enriching agent listings)\n- clear_agent_presence(redis, agent_ids) → count deleted\n\nFollow the patterns from beadhub-main's presence.py but strip all workspace/repo/branch-specific code. Keep: URL-encoded key components, lazy stale index cleanup, pipeline batching, 2x TTL on indexes.\n\nRedis is optional in aweb (app.state.redis can be None). All presence functions must handle redis=None gracefully (return empty results).","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:39:22.843454Z","created_by":"Juan Reyero","updated_at":"2026-02-04T09:56:08.37169Z","closed_at":"2026-02-04T09:56:08.37169Z","close_reason":"Implemented and tested: GET /v1/agents + presence module. 13 new tests passing.","dependencies":[{"issue_id":"aweb-gkv.2","depends_on_id":"aweb-gkv","type":"parent-child","created_at":"2026-02-04T09:39:22.84469Z","created_by":"Juan Reyero"}]}
{"id":"aweb-gkv.3","title":"Add POST /v1/agents/heartbeat endpoint","description":"Add a heartbeat endpoint that agents call to report liveness.\n\nPOST /v1/agents/heartbeat\n- Requires auth (Bearer API key) → resolves project_id and agent_id\n- Request body: optional fields (status: str)\n- Calls update_agent_presence() from the presence module\n- Returns {agent_id, last_seen, ttl_seconds}\n- Best-effort: if Redis is unavailable, log warning and return success (SQL is authoritative, presence is a cache)\n\nThis is simpler than beadhub's workspace heartbeat — no repo resolution, no immutability checks, no SQL upsert. Just 'I am alive, refresh my TTL.'\n\nDepends on: aweb-gkv.2 (presence module)","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:39:30.701439Z","created_by":"Juan Reyero","updated_at":"2026-02-04T09:58:53.195578Z","closed_at":"2026-02-04T09:58:53.195578Z","close_reason":"Heartbeat endpoint implemented with 4 tests. Agent listing enrichment was already done in aweb-gkv.1.","dependencies":[{"issue_id":"aweb-gkv.3","depends_on_id":"aweb-gkv","type":"parent-child","created_at":"2026-02-04T09:39:30.702672Z","created_by":"Juan Reyero"},{"issue_id":"aweb-gkv.3","depends_on_id":"aweb-gkv.2","type":"blocks","created_at":"2026-02-04T09:39:55.399046Z","created_by":"Juan Reyero"}]}
{"id":"aweb-gkv.4","title":"Enrich GET /v1/agents with online status from presence","description":"Update the GET /v1/agents endpoint (aweb-gkv.1) to enrich agent listings with online/last_seen from the presence module (aweb-gkv.2).\n\nAfter fetching agents from the DB, call list_agent_presences_by_ids() to get presence data. For each agent, set:\n- online: bool (true if presence exists and not expired)\n- last_seen: ISO timestamp from presence, or null\n\nWhen Redis is unavailable (app.state.redis is None), online=false and last_seen=null for all agents.\n\nThe aw Go client's AgentView struct already expects these fields:\n  Online    bool   json:online\n  LastSeen  string json:last_seen,omitempty\n  Status    string json:status,omitempty\n\nDepends on: aweb-gkv.1 (agents endpoint), aweb-gkv.2 (presence module)","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:39:38.534055Z","created_by":"Juan Reyero","updated_at":"2026-02-04T09:58:53.197827Z","closed_at":"2026-02-04T09:58:53.197827Z","close_reason":"Heartbeat endpoint implemented with 4 tests. Agent listing enrichment was already done in aweb-gkv.1.","dependencies":[{"issue_id":"aweb-gkv.4","depends_on_id":"aweb-gkv","type":"parent-child","created_at":"2026-02-04T09:39:38.53538Z","created_by":"Juan Reyero"},{"issue_id":"aweb-gkv.4","depends_on_id":"aweb-gkv.1","type":"blocks","created_at":"2026-02-04T09:39:55.751536Z","created_by":"Juan Reyero"},{"issue_id":"aweb-gkv.4","depends_on_id":"aweb-gkv.2","type":"blocks","created_at":"2026-02-04T09:39:56.098844Z","created_by":"Juan Reyero"}]}
{"id":"aweb-gkv.5","title":"aw client: add Heartbeat() method","description":"Add a Heartbeat() method to the aw Go client (aw/client.go).\n\nfunc (c *Client) Heartbeat(ctx context.Context, req *HeartbeatRequest) (*HeartbeatResponse, error)\n\ntype HeartbeatRequest struct {\n    Status string `json:\"status,omitempty\"`\n}\n\ntype HeartbeatResponse struct {\n    AgentID  string `json:\"agent_id\"`\n    LastSeen string `json:\"last_seen\"`\n    TTL      int    `json:\"ttl_seconds\"`\n}\n\nCalls POST /v1/agents/heartbeat with Bearer API key auth.\n\nDepends on: aweb-gkv.3 (heartbeat endpoint exists)","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:39:43.994535Z","created_by":"Juan Reyero","updated_at":"2026-02-04T10:07:40.610447Z","closed_at":"2026-02-04T10:07:40.610447Z","close_reason":"Heartbeat client method + CLI goroutine implemented, tested, committed, pushed","dependencies":[{"issue_id":"aweb-gkv.5","depends_on_id":"aweb-gkv","type":"parent-child","created_at":"2026-02-04T09:39:43.995804Z","created_by":"Juan Reyero"},{"issue_id":"aweb-gkv.5","depends_on_id":"aweb-gkv.3","type":"blocks","created_at":"2026-02-04T09:39:56.442346Z","created_by":"Juan Reyero"}]}
{"id":"aweb-gkv.6","title":"aw CLI: call heartbeat on every command","description":"Integrate heartbeat into the aw CLI (aw/cmd/aw/main.go), similar to how bdh calls refreshPresenceHeartbeat() on every command.\n\nOn every aw CLI invocation:\n1. Load config (API key, base URL)\n2. Call client.Heartbeat() in a goroutine (best-effort, non-blocking)\n3. Don't fail the command if heartbeat fails (log warning at most)\n\nThis ensures that any agent using aw stays visible in presence as long as they're actively running commands.\n\nDepends on: aweb-gkv.5 (aw client Heartbeat method)","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T09:39:50.555585Z","created_by":"Juan Reyero","updated_at":"2026-02-04T10:07:40.638242Z","closed_at":"2026-02-04T10:07:40.638242Z","close_reason":"Heartbeat client method + CLI goroutine implemented, tested, committed, pushed","dependencies":[{"issue_id":"aweb-gkv.6","depends_on_id":"aweb-gkv","type":"parent-child","created_at":"2026-02-04T09:39:50.556385Z","created_by":"Juan Reyero"},{"issue_id":"aweb-gkv.6","depends_on_id":"aweb-gkv.5","type":"blocks","created_at":"2026-02-04T09:39:56.788181Z","created_by":"Juan Reyero"}]}
{"id":"aweb-rwf","title":"Add sender_waiting to SSE message events","description":"Modify _sse_events() in chat.py: Add from_agent_id to both replay and live message SELECT queries. Before yielding each message event, call is_agent_waiting(redis, session_id, from_agent_id). Include 'sender_waiting': bool in the event payload. Tests: test_sse_message_includes_sender_waiting_true — Agent 1 has active SSE, sends message, Agent 2's SSE stream shows sender_waiting: true. test_sse_message_sender_waiting_false_without_redis — With redis=None, always false.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:35:02.292193Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:46:35.973044Z","closed_at":"2026-02-07T23:46:35.973044Z","close_reason":"All endpoints wired, Lua TOCTOU fix, 24 tests passing","dependencies":[{"issue_id":"aweb-rwf","depends_on_id":"aweb-axv","type":"blocks","created_at":"2026-02-07T23:35:23.134668Z","created_by":"Juan Reyero"}]}
{"id":"aweb-tji","title":"Wire sender_waiting into aweb chat protocol","description":"Agents using aweb chat have no way to know if the other side is actively listening on SSE. sender_waiting is hardcoded to False, targets_connected is hardcoded to []. Wire Redis connection tracking (ZADD/ZREM/ZSCORE) into SSE lifecycle. Separate chat_waiting module following presence.py pattern.","status":"in_progress","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:34:42.665026Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:36:22.764292Z"}
{"id":"aweb-ye1","title":"Un-hardcode sender_waiting in GET /v1/chat/pending","description":"Modify pending() in chat.py: Add redis=Depends(get_redis). Add agent_id aggregation to the SQL query (alongside existing alias aggregation). For each pending session, call get_waiting_agents() for non-self participants. Set sender_waiting = len(waiting) \u003e 0. Tests: test_pending_sender_waiting_true — Agent 1 sends + has active SSE, Agent 2's pending shows sender_waiting: True. test_pending_sender_waiting_false_no_sse — Agent 1 sends but no SSE, Agent 2's pending shows sender_waiting: False.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:35:05.682808Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:46:35.974244Z","closed_at":"2026-02-07T23:46:35.974244Z","close_reason":"All endpoints wired, Lua TOCTOU fix, 24 tests passing","dependencies":[{"issue_id":"aweb-ye1","depends_on_id":"aweb-axv","type":"blocks","created_at":"2026-02-07T23:35:24.902934Z","created_by":"Juan Reyero"}]}
